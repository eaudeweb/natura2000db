{% set html = form_generator %}

{% macro widget(field, label=True) %}
  {%- set macro = {
      'input': input,
      'radio': radio,
      'checkbox': checkbox,
      'dict': dict,
      'list': list,
      'textarea': textarea,
      'section': section,
      'table': table,
    }[field.properties.widget] or input -%}
  {{- macro(field, label=label) -}}
{% endmacro %}

{% macro errors(field) %}
  {% for msg in field.errors %}
    <span class="error">{{ msg }}</span>
  {% endfor -%}
{% endmacro %}

{% macro input(field, label=True) %}
  {%- do html.begin(auto_domid=true, auto_for=true) %}
  {% if label %}
  {{ html.label(field, contents=field.properties.label) }}
  {% endif %}
  {{ html.input(field, type=field.properties.type) }}
  {{- errors(field) -}}<br />
  {%- do html.end() %}
{% endmacro %}

{% macro radio(field, label=True) %}
  {%- do html.begin(auto_domid=true, auto_for=true) %}
  <td>
  {% for value in field.valid_values %}
    {{ html.input(field, type="radio", value=value) }}
  {% endfor %}
  {{- errors(field) -}}
  </td>
  {%- do html.end() %}
{% endmacro %}

{% macro textarea(field, label=True) %}
  {%- do html.begin(auto_domid=true, auto_for=true) %}
  {{ html.label(field, contents=field.properties.label) }}
  {{ html.textarea(field) }}
  {{- errors(field) -}}<br />
  {%- do html.end() %}
{% endmacro %}

{% macro checkbox(field, label=True) %}
  {%- do html.begin(auto_domid=true, auto_for=true) %}
  {{ html.label(field, contents=field.properties.label) }}
  {{ html.input(field, type="checkbox") }}
  {{- errors(field) -}}<br />
  {%- do html.end() %}
{% endmacro %}

{% macro dict_children(field) %}
  {%- for child_name in field.properties.order %}
  {{ widget(field[child_name]) }}
  {% endfor -%}
{% endmacro %}

{% macro dict(field, label=True) %}
  <p>{{ field.properties.label }}</p>
  {{ dict_children(field) }}
{% endmacro %}

{% macro list(field, label=True) %}
  {{ field.properties.label }} <br />
  {{ field.append('') or "" }}
  {{ field.append('') or "" }}
  {% for child in field %}
  {{ widget(child) }}
  {% endfor %}
{% endmacro %}

{% macro table(field, label=True) %}
  {%- do html.begin(auto_domid=true, auto_for=true) %}
  <table>
    <thead>
      {{ field.append('') or "" }}
      {{ field.append('') or "" }}
      <tr>
        {% for child_name in field[0].properties.order %}
        <td>{{ field[0][child_name].properties.label }}</td>
        {% endfor %}
    </thead>
    <tbody>
      {% for child in field %}
      <tr>
        {% for name in child.properties.order %}
        <td>{{ widget(child[name], label=False) }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {%- do html.end() %}
{% endmacro %}


{% macro section(field, label=True) %}
  {%- do html.begin(auto_domid=true, auto_for=true) %}
  <h2>{{ field.properties.label }}</h2>
  {{ dict_children(field) }}
  {%- do html.end() %}
{% endmacro %}